<html>
    <head>
        <meta charset="utf-8" />
        <title>APES Score Processor</title>
        <script src="https://cdn.jsdelivr.net/npm/@highcharts/grid-lite/grid-lite.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highcharts/grid-lite/css/grid.css" />
        <script>
            const processor = (function() {
                console.log('ready')
                return {
                    baseInfo: [],
                    questions: [],

                    readFile: function() {
                        let file = document.getElementById("file").files[0]
                        if (file) {
                            let reader = new FileReader()

                            reader.onload = (e) => {
                                let content = e.target.result
                                this.process(content)
                            }

                            reader.onerror = (e) => {
                                console.error("Error reading file: ", e)
                            }

                            reader.readAsText(file)
                        } else {
                            console.log('no file selected')
                        }
                    },

                    process: function(data) {
                        let parsedData = this.parse(data, '\r\n', ',')
                        let processedData = []
                        let columns = {
                            Name: []
                        }

                        parsedData.forEach((row, index) => {
                            switch (index) {
                                case 0:
                                    /** demographics and question names */
                                    row.forEach((item, i) => {
                                        if (i < 12) {
                                            this.baseInfo.push(item)
                                        } else {
                                            this.questions[i] = {name: item}
                                        }
                                    })
                                    break
                                case 1:
                                    /** group names */
                                    row.forEach((item, i) => {
                                        if (i > 11) {
                                            this.questions[i].group = item
                                            if (!columns.hasOwnProperty(item)) {
                                                columns[item] = []
                                            }
                                        }
                                    })
                                    break
                                case 2:
                                    /** answers */
                                    row.forEach((item, i) => {
                                        if (i > 11 && item) {
                                            this.questions[i].answer = item
                                        }
                                    })
                                    break
                                default:
                                    let studentData = {}
                                    row.forEach((item, i) => {
                                        if (i < 12) {
                                            studentData[this.baseInfo[i]] = item
                                        } else {
                                            let question = this.questions[i]
                                            let group = question.group
                                            
                                            if (!studentData.hasOwnProperty(group)) {
                                                studentData[group] = 0
                                            }
                                            
                                            if (group === 'FRQ') {
                                                studentData[group] += isNaN(item) ? 0 : parseInt(item)
                                            } else {
                                                studentData[group] += item == question.answer ? 1 : 0
                                            }
                                        }
                                    })
                                    processedData.push(studentData)
                            }
                        })

                        this.prepareGrid(processedData, columns)
                    },

                    parse: function(csv, rowTerminator, cellTerminator) {
                        return csv.split(rowTerminator).map(row => row.split(cellTerminator))
                    },

                    prepareGrid: function(data, columns) {
                        let grid = {
                            caption: {},
                            dataTable: {
                                columns
                            },
                            columnDefaults: {
                                sorting: {
                                    sortable: true
                                }
                            },
                        }

                        data.forEach((item, index) => {
                            if (!index) {
                                grid.caption.text = item["Assignment Name"]
                            }
                            if (item["Student Last Name"]){
                                Object.keys(columns).forEach(key => {
                                    if (key === 'Name') {
                                        columns.Name.push(item["Student Last Name"] + ', ' + item["Student First Name"])
                                    } else {
                                        columns[key].push(item[key])
                                    }
                                })
                            }
                        })

                        console.log('grid', grid)
                        Grid.grid("grid", grid)
                        document.getElementById('grid').style.display = "block"
                    }
                }
            })()
        </script>
        <style>
            body {
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }

            #wrapper {
                display: flex;
                flex-direction: column;
                height: 100%;
                width: 100%;
            }

            #header-wrapper {
                padding: 1px 16px 12px 16px;
                flex: 0 0;
            }

            #grid-wrapper {
                height: auto;
                flex: 1 1;
            }

            #grid {
                width: 100%;
                height: 100%;
            }

            .m-3 {
                margin-top: 12px;
            }

            .hcg-caption {  
                background: var(--hcg-background);
                padding-top: 10px;
            }
        </style>
    </head>
    <body>
        <div id="wrapper">
            <div id="header-wrapper">
                <h2>Score Processor</h2>
                <div>
                    <input id="file" type="file">
                </div>
                <div class="m-3">
                    <button onclick="processor.readFile()">Process</button>
                </div>
            </div>
            <div id="grid-wrapper">
                <div id="grid" style="display: none;"></div>
            </div>
        </div>
    </body>
</html>